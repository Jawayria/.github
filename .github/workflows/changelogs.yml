# Uses python-semantic-release package to determine whether a version bump is required
# and calls the changelogs-generator actions in case of version bump

name: Generate Changelogs

on:
  - workflow_call

jobs:
  check_version:
    runs-on: ubuntu-20.04
    outputs:
      output1: ${{ steps.gitversion.outputs.version }}
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: setup python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Install package
      run: pip install python-semantic-release

    - name: Get Commits
      run: git log --oneline

  # Make sure you've added version_variable in setup.cfg
    - name: Determine Version
      id: gitversion
      run: echo "::set-output name=version::$(semantic-release print-version)"

  update_changelogs:
    needs: check_version
    runs-on: ubuntu-20.04
    if: ${{ !(needs.check_version.outputs.output1 == null) }}
    steps:
    - uses: edx/.github/.github/actions/changelogs-generator@jawayria/semantic-release
      with:
        repo_name: ${{ github.repository }}
        version: ${{ needs.check_version.outputs.output1 }}
